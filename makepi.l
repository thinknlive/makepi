# PicoLisp
# Derived from the following Haskell code described here
# https://www.cs.ox.ac.uk/people/jeremy.gibbons/publications/spigot.pdf

(de digit (Env)
   (job Env
      (tco (Q R S K N L)
         (if (>= (- (+ R (* 4 Q)) S) (* N S))
            (tc
               (* Q K)
               (* L (+ R (* 2 Q)))
               (* S L)
               (inc K)
               (/ (+ (* Q (+ 2 (* 7 K))) (* R L)) (* S L))
               (+ 2 L) ) )
         (prog1 N
            (let M (- (/ (* 10 (+ R (* 3 Q))) S) (* 10 N))
               (setq Q (* 10 Q)  R (* 10 (- R (* N S)))  N M) ) ) ) ) )

# Print 'N' or all digits of PI
(de pi (N)
   (let E (env 'Q 1  'R 0  'S 1  'K 1  'N 3  'L 3)
      (do (or N T)
         (prin (digit E))
         (flush) ) )
   (prinl) )

#{
Optimized Gosper Series PI

> piG3 = g(1,180,60,2) where
> g(q,r,t,i) = let (u,y)=(3*(3*i+1)*(3*i+2),div(q*(27*i-12)+5*r)(5*t))
> in y : g(10*q*i*(2*i-1),10*u*(q*(5*i-2)+r-y*t),t*u,i+1)
}#

: (mapc pp '(makePiCo prinPiCo))

(de makePiCo (Flg)
   (if Flg
      (co 'yieldPi
         (let (G 1  R 180  S 60  I 2)
            (tco
               (G R S I N)
               (let
                  (U
                     (*
                        3
                        (+ (* 3 I) 1)
                        (+ (* 3 I) 2) )
                     Y
                     (/
                        (+
                           (* G (- (* 27 I) 12))
                           (* 5 R) )
                        (* 5 S) ) )
                  (yield Y)
                  (if (or (not N) (gt0 N))
                     (tc
                        (* 10 G I (- (* 2 I) 1))
                        (*
                           10
                           U
                           (-
                              (+ (* G (- (* 5 I) 2)) R)
                              (* Y S) ) )
                        (* S U)
                        (+ I 1)
                        (dec N) ) ) ) ) ) )
      (co 'yieldPi) ) )
(de prinPiCo (N)
   (makePiCo)
   (do N
      (prin (makePiCo T)) )
   (makePiCo)
   (prinl) )
-> prinPiCo
:


#{

: (bench (prinPiCo 4096))
31415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446
09550582231725359408128481117450284102701938521105559644622948954930381964428810975665933446128475648233786783165271201909145648
56692346034861045432664821339360726024914127372458700660631558817488152092096282925409171536436789259036001133053054882046652138
41469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624
40656643086021394946395224737190702179860943702770539217176293176752384674818467669405132000568127145263560827785771342757789609
17363717872146844090122495343014654958537105079227968925892354201995611212902196086403441815981362977477130996051870721134999999
83729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691
47303598253490428755468731159562863882353787593751957781857780532171226806613001927876611195909216420198938095257201065485863278
86593615338182796823030195203530185296899577362259941389124972177528347913151557485724245415069595082953311686172785588907509838
17546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346
46208046684259069491293313677028989152104752162056966024058038150193511253382430035587640247496473263914199272604269922796782354
78163600934172164121992458631503028618297455570674983850549458858692699569092721079750930295532116534498720275596023648066549911
98818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525
52133475741849468438523323907394143334547762416862518983569485562099219222184272550254256887671790494601653466804988627232791786
08578438382796797668145410095388378636095068006422512520511739298489608412848862694560424196528502221066118630674427862203919494
50471237137869609563643719172874677646575739624138908658326459958133904780275900994657640789512694683983525957098258226205224894
07726719478268482601476990902640136394437455305068203496252451749399651431429809190659250937221696461515709858387410597885959772
97549893016175392846813826868386894277415599185592524595395943104997252468084598727364469584865383673622262609912460805124388439
04512441365497627807977156914359977001296160894416948685558484063534220722258284886481584560285060168427394522674676788952521385
22549954666727823986456596116354886230577456498035593634568174324112515076069479451096596094025228879710893145669136867228748940
56010150330861792868092087476091782493858900971490967598526136554978189312978482168299894872265880485756401427047755513237964145
15237462343645428584447952658678210511413547357395231134271661021359695362314429524849371871101457654035902799344037420073105785
39062198387447808478489683321445713868751943506430218453191048481005370614680674919278191197939952061419663428754440643745123718
19217999839101591956181467514269123974894090718649423196156794520809514655022523160388193014209376213785595663893778708303906979
20773467221825625996615014215030680384477345492026054146659252014974428507325186660021324340881907104863317346496514539057962685
61005508106658796998163574736384052571459102897064140110971206280439039759515677157700420337869936007230558763176359421873125147
12053292819182618612586732157919841484882916447060957527069572209175671167229109816909152801735067127485832228718352093539657251
21083579151369882091444210067510334671103141267111369908658516398315019701651511685171437657618351556508849099898599823873455283
31635507647918535893226185489632132933089857064204675259070915481416549859461637180270981994309924488957571282890592323326097299
71208443357326548938239119325974636673058360414281388303203824903758985243744170291327656180937734440307074692112019130203303801
97621101100449293215160842444859637669838952286847831235526582131449576857262433441893039686426243410773226978028073189154411010
44682325271620105265227211166039666557309254711055785376346682065310989652691862056476931257058635662018558100729360659876486117

1.410 sec
-> NIL
:

}#
